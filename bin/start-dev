#!/usr/bin/env bash

# =============================================================================
# KARRIO DEVELOPMENT SERVER STARTER
# =============================================================================
# Starts the complete Karrio development environment:
# - Caddy SSL proxy for local domains
# - Karrio API server
# - Karrio Dashboard
# =============================================================================

set -e

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT_DIR="$( cd "$SCRIPT_DIR/.." && pwd )"

# Change to root directory
cd "$ROOT_DIR"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Utility functions
print_step() { echo -e "${CYAN}→ $1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠ $1${NC}"; }
print_error() { echo -e "${RED}✗ $1${NC}"; }
command_exists() { command -v "$1" >/dev/null 2>&1; }

# Header
echo -e "${BLUE}"
echo "██╗  ██╗ █████╗ ██████╗ ██████╗ ██╗ ██████╗ "
echo "██║ ██╔╝██╔══██╗██╔══██╗██╔══██╗██║██╔═══██╗"
echo "█████╔╝ ███████║██████╔╝██████╔╝██║██║   ██║"
echo "██╔═██╗ ██╔══██║██╔══██╗██╔══██╗██║██║   ██║"
echo "██║  ██╗██║  ██║██║  ██║██║  ██║██║╚██████╔╝"
echo "╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝ ╚═════╝ "
echo -e "${NC}"
echo "Starting Development Environment"
echo ""

# =============================================================================
# PREREQUISITE CHECKS
# =============================================================================
print_step "Checking prerequisites..."

# Check Caddy
if ! command_exists caddy; then
    print_error "Caddy not found. Please run ./bin/setup-dev-env first"
    exit 1
fi

# Check Caddyfile
if [[ ! -f ".karrio/caddy/Caddyfile" ]]; then
    print_error "Caddyfile not found. Please run ./bin/setup-dev-env first"
    exit 1
fi

# Check Python virtual environment
if [[ ! -d ".venv/karrio" ]]; then
    print_error "Python virtual environment not found. Please run ./bin/setup-dev-env first"
    exit 1
fi

# Check Node.js dependencies
if [[ ! -d "node_modules" ]]; then
    print_warning "Node.js dependencies not found. Running npm install..."
    npm install
fi

# Check local domains
if ! grep -q "api.karrio.local" /etc/hosts 2>/dev/null; then
    print_warning "Local domains not configured in /etc/hosts"
    print_warning "Run: sudo ./bin/manage-hosts add"
fi

print_success "All prerequisites satisfied"

# =============================================================================
# CLEANUP FUNCTION
# =============================================================================
cleanup() {
    echo ""
    echo "Shutting down development environment..."
    
    # Kill all child processes
    pkill -P $$ 2>/dev/null || true
    
    # Kill specific processes by port
    for port in 5002 3000 443; do
        # macOS doesn't have xargs -r, so we handle it differently
        pids=$(lsof -ti :$port 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
            echo "$pids" | xargs kill 2>/dev/null || true
        fi
    done
    
    # Additional cleanup for common processes
    pkill -f "caddy run" 2>/dev/null || true
    pkill -f "karrio runserver" 2>/dev/null || true
    pkill -f "npm.*@karrio/dashboard" 2>/dev/null || true
    
    echo "Development environment stopped"
    exit 0
}

# Trap signals to ensure cleanup
trap cleanup SIGINT SIGTERM EXIT

# =============================================================================
# START SERVICES
# =============================================================================

# Start Caddy
print_step "Starting Caddy SSL proxy..."
cd .karrio/caddy
caddy run --config Caddyfile &
CADDY_PID=$!
cd - > /dev/null
sleep 2

# Start API server
print_step "Starting Karrio API server..."

# Activate virtual environment and start server in subshell
(
    source bin/activate-env
    if [[ -f "bin/start-server" ]]; then
        ./bin/start-server
    else
        karrio runserver
    fi
) &
SERVER_PID=$!
sleep 3

# Start Dashboard
print_step "Starting Karrio Dashboard..."
npm run dev -w @karrio/dashboard &
DASHBOARD_PID=$!
sleep 3

# =============================================================================
# SHOW ACCESS INFO
# =============================================================================
echo ""
print_success "Development environment started! 🚀"
echo ""
echo -e "${GREEN}Access your application:${NC}"
echo "   → API: https://api.karrio.local"
echo "   → Dashboard: https://app.karrio.local"
echo "   → Admin: https://api.karrio.local/admin"
echo ""
echo -e "${YELLOW}Direct access (if domains not configured):${NC}"
echo "   → API: http://localhost:5002"
echo "   → Dashboard: http://localhost:3000"
echo ""
echo -e "${CYAN}Press Ctrl+C to stop all services${NC}"
echo ""

# Wait for user to stop
wait