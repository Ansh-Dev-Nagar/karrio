---
sidebarTitle: Events
title: Events
description: Event-driven architecture for real-time shipping notifications and system integration
tags: ["events", "real-time", "notifications", "integration", "event-driven"]
---

# Events

Karrio's Event system provides a comprehensive event-driven architecture for real-time shipping notifications and system integration. Subscribe to shipping events, track system activities, and build responsive applications that react to shipping lifecycle changes.

## Overview

The Event system enables real-time communication between Karrio and your applications through a robust event-driven architecture. Get instant notifications when shipments are created, tracking status changes, orders are fulfilled, and more.

### Key Features

- **Real-time Events**: Instant notifications when shipping events occur
- **Event Streaming**: Continuous event streams for real-time processing
- **Event History**: Complete audit trail of all system events
- **Custom Event Handlers**: Build custom logic to respond to events
- **Event Filtering**: Subscribe only to relevant events

## Event Types

### Shipment Events

Track the complete shipment lifecycle:

```bash
# Subscribe to shipment events
curl -X POST "https://api.karrio.io/v1/events/subscriptions" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "event_types": [
      "shipment.created",
      "shipment.purchased",
      "shipment.cancelled",
      "shipment.updated"
    ],
    "endpoint": "https://your-app.com/events/shipments"
  }'

# Example shipment.created event
{
  "id": "evt_123456",
  "type": "shipment.created",
  "timestamp": "2024-01-15T10:30:00Z",
  "data": {
    "shipment": {
      "id": "shp_789",
      "tracking_number": "1Z999AA1234567890",
      "carrier_name": "ups",
      "service": "ups_ground",
      "status": "created",
      "recipient": {
        "person_name": "John Doe",
        "city": "Los Angeles",
        "state_code": "CA"
      }
    }
  },
  "metadata": {
    "user_id": "user_123",
    "organization_id": "org_456"
  }
}
```

### Tracking Events

Monitor package delivery progress:

```bash
# Example tracking events
{
  "type": "tracking.status_updated",
  "data": {
    "tracking_number": "1Z999AA1234567890",
    "status": "in_transit",
    "location": "Los Angeles, CA",
    "timestamp": "2024-01-15T14:30:00Z",
    "carrier": "ups",
    "events": [
      {
        "code": "DP",
        "description": "Departed facility",
        "location": "Los Angeles, CA",
        "timestamp": "2024-01-15T14:30:00Z"
      }
    ]
  }
}

{
  "type": "tracking.delivered",
  "data": {
    "tracking_number": "1Z999AA1234567890",
    "status": "delivered",
    "delivered_to": "Front door",
    "signature": "J.DOE",
    "delivery_timestamp": "2024-01-16T16:45:00Z"
  }
}

{
  "type": "tracking.exception",
  "data": {
    "tracking_number": "1Z999AA1234567890",
    "status": "exception",
    "exception_code": "UPS001",
    "exception_description": "Address correction required",
    "location": "Los Angeles, CA"
  }
}
```

### Order Events

Track order fulfillment and lifecycle:

```bash
# Example order events
{
  "type": "order.created",
  "data": {
    "order": {
      "id": "ord_123",
      "reference": "ORDER-2024-001",
      "status": "pending",
      "items": [
        {
          "sku": "ITEM001",
          "quantity": 2,
          "description": "Product Name"
        }
      ],
      "shipping_address": {
        "person_name": "John Doe",
        "address_line1": "123 Main St",
        "city": "Los Angeles",
        "state_code": "CA",
        "postal_code": "90210"
      }
    }
  }
}

{
  "type": "order.fulfilled",
  "data": {
    "order_id": "ord_123",
    "shipment_id": "shp_789",
    "tracking_number": "1Z999AA1234567890",
    "fulfillment_timestamp": "2024-01-15T10:30:00Z"
  }
}
```

### System Events

Monitor system-level activities:

```bash
# Example system events
{
  "type": "batch.completed",
  "data": {
    "batch_id": "batch_456",
    "operation": "create_shipments",
    "total_items": 100,
    "successful_items": 98,
    "failed_items": 2,
    "completion_time": "2024-01-15T11:00:00Z"
  }
}

{
  "type": "carrier.connection_failed",
  "data": {
    "carrier": "fedex",
    "connection_id": "conn_789",
    "error_code": "AUTH_FAILED",
    "error_message": "Invalid credentials",
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

## Event Streaming

### Real-time Event Stream

```bash
# Connect to event stream
curl -X GET "https://api.karrio.io/v1/events/stream" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Accept: text/event-stream" \
  -d '{
    "event_types": ["shipment.*", "tracking.*"],
    "filters": {
      "organization_id": "org_456"
    }
  }'

# Server-sent events stream
event: shipment.created
data: {"id":"evt_123","type":"shipment.created","data":{...}}

event: tracking.status_updated
data: {"id":"evt_124","type":"tracking.status_updated","data":{...}}

event: shipment.purchased
data: {"id":"evt_125","type":"shipment.purchased","data":{...}}
```

### Event Filtering

```bash
# Advanced event filtering
curl -X POST "https://api.karrio.io/v1/events/subscriptions" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "event_types": ["tracking.*"],
    "filters": {
      "carrier": ["fedex", "ups"],
      "status": ["delivered", "exception"],
      "value_range": {
        "min": 100,
        "max": 1000
      }
    },
    "endpoint": "https://your-app.com/events/high-value-tracking"
  }'
```

## Event History

### Query Event History

```bash
# Get event history
curl -X GET "https://api.karrio.io/v1/events" \
  -H "Authorization: Token YOUR_API_KEY" \
  -d '{
    "start_date": "2024-01-15T00:00:00Z",
    "end_date": "2024-01-15T23:59:59Z",
    "event_types": ["shipment.created", "tracking.delivered"],
    "limit": 100,
    "offset": 0
  }'

# Response includes event history
{
  "events": [
    {
      "id": "evt_123456",
      "type": "shipment.created",
      "timestamp": "2024-01-15T10:30:00Z",
      "data": {...},
      "metadata": {...}
    }
  ],
  "total": 1250,
  "has_more": true
}
```

### Event Replay

```bash
# Replay events for debugging or recovery
curl -X POST "https://api.karrio.io/v1/events/replay" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "event_ids": ["evt_123", "evt_124", "evt_125"],
    "target_endpoint": "https://your-app.com/events/replay",
    "replay_speed": "1x"
  }'

# Replay events within time range
curl -X POST "https://api.karrio.io/v1/events/replay" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "start_date": "2024-01-15T10:00:00Z",
    "end_date": "2024-01-15T11:00:00Z",
    "event_types": ["shipment.*"],
    "target_endpoint": "https://your-app.com/events/replay"
  }'
```

## Event Subscriptions

### Managing Subscriptions

```bash
# Create event subscription
curl -X POST "https://api.karrio.io/v1/events/subscriptions" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Order Fulfillment Events",
    "description": "Track order fulfillment process",
    "event_types": [
      "order.created",
      "order.fulfilled",
      "shipment.created",
      "tracking.delivered"
    ],
    "endpoint": "https://your-app.com/webhooks/fulfillment",
    "secret": "your-webhook-secret",
    "retry_policy": {
      "max_retries": 3,
      "retry_delay": 60
    }
  }'

# List subscriptions
curl -X GET "https://api.karrio.io/v1/events/subscriptions" \
  -H "Authorization: Token YOUR_API_KEY"

# Update subscription
curl -X PATCH "https://api.karrio.io/v1/events/subscriptions/sub_123" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "event_types": ["shipment.*", "tracking.*"],
    "enabled": true
  }'
```

### Subscription Testing

```bash
# Test subscription endpoint
curl -X POST "https://api.karrio.io/v1/events/subscriptions/sub_123/test" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "shipment.created",
    "test_data": {
      "shipment_id": "test_shp_123",
      "tracking_number": "TEST123456789"
    }
  }'
```

## Event Processing

### Event Handlers

```javascript
// Example: Event handler implementation
class ShippingEventHandler {
  constructor(apiKey) {
    this.apiKey = apiKey;
  }

  async handleEvent(event) {
    console.log(`Processing event: ${event.type}`);

    switch (event.type) {
      case "shipment.created":
        await this.handleShipmentCreated(event.data);
        break;

      case "tracking.delivered":
        await this.handleDelivery(event.data);
        break;

      case "tracking.exception":
        await this.handleException(event.data);
        break;

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }
  }

  async handleShipmentCreated(data) {
    // Update internal order status
    await this.updateOrderStatus(data.shipment.reference, "shipped");

    // Send customer notification
    await this.sendTrackingNotification(data.shipment);

    // Update inventory
    await this.updateInventory(data.shipment.items);
  }

  async handleDelivery(data) {
    // Mark order as delivered
    await this.updateOrderStatus(data.reference, "delivered");

    // Send delivery confirmation
    await this.sendDeliveryConfirmation(data);

    // Trigger post-delivery workflows
    await this.triggerPostDeliveryWorkflow(data);
  }

  async handleException(data) {
    // Log exception for investigation
    await this.logException(data);

    // Notify customer service
    await this.notifyCustomerService(data);

    // Attempt automatic resolution
    await this.attemptAutoResolution(data);
  }
}

// Usage
const eventHandler = new ShippingEventHandler("your-api-key");

// Express.js webhook endpoint
app.post("/webhooks/shipping-events", async (req, res) => {
  try {
    const event = req.body;

    // Verify event signature
    if (!verifyEventSignature(req)) {
      return res.status(401).send("Unauthorized");
    }

    // Process event
    await eventHandler.handleEvent(event);

    res.status(200).send("OK");
  } catch (error) {
    console.error("Event processing error:", error);
    res.status(500).send("Internal Server Error");
  }
});
```

### Event Aggregation

```javascript
// Example: Event aggregation for analytics
class EventAggregator {
  constructor() {
    this.metrics = new Map();
  }

  processEvent(event) {
    const key = `${event.type}:${this.getDateKey(event.timestamp)}`;

    if (!this.metrics.has(key)) {
      this.metrics.set(key, {
        count: 0,
        first_seen: event.timestamp,
        last_seen: event.timestamp,
      });
    }

    const metric = this.metrics.get(key);
    metric.count++;
    metric.last_seen = event.timestamp;

    // Specific event processing
    switch (event.type) {
      case "shipment.created":
        this.trackShipmentMetrics(event);
        break;

      case "tracking.delivered":
        this.trackDeliveryMetrics(event);
        break;
    }
  }

  getDateKey(timestamp) {
    return new Date(timestamp).toISOString().split("T")[0];
  }

  generateReport() {
    const report = {
      daily_metrics: {},
      event_types: {},
      trends: {},
    };

    for (const [key, metric] of this.metrics) {
      const [eventType, date] = key.split(":");

      if (!report.daily_metrics[date]) {
        report.daily_metrics[date] = {};
      }

      report.daily_metrics[date][eventType] = metric.count;

      if (!report.event_types[eventType]) {
        report.event_types[eventType] = 0;
      }

      report.event_types[eventType] += metric.count;
    }

    return report;
  }
}
```

## Event Security

### Event Verification

```javascript
// Verify event signatures
function verifyEventSignature(request) {
  const crypto = require("crypto");
  const signature = request.headers["x-karrio-signature"];
  const secret = process.env.WEBHOOK_SECRET;

  const expectedSignature = crypto
    .createHmac("sha256", secret)
    .update(JSON.stringify(request.body))
    .digest("hex");

  return signature === `sha256=${expectedSignature}`;
}

// Event authentication
function authenticateEvent(event) {
  // Verify event timestamp (prevent replay attacks)
  const eventTime = new Date(event.timestamp);
  const now = new Date();
  const timeDiff = Math.abs(now - eventTime);

  if (timeDiff > 5 * 60 * 1000) {
    // 5 minutes
    throw new Error("Event timestamp too old");
  }

  // Verify event structure
  if (!event.id || !event.type || !event.data) {
    throw new Error("Invalid event structure");
  }

  return true;
}
```

## Best Practices

### Event Handling

1. **Idempotent Processing**: Handle duplicate events gracefully
2. **Error Handling**: Implement robust error handling and retry logic
3. **Event Ordering**: Don't assume events arrive in order
4. **Timeout Handling**: Set appropriate timeouts for event processing

### Performance Optimization

```javascript
// Example: Optimized event processing
class OptimizedEventProcessor {
  constructor() {
    this.eventQueue = [];
    this.processing = false;
    this.batchSize = 10;
    this.batchTimeout = 1000; // 1 second
  }

  async addEvent(event) {
    this.eventQueue.push(event);

    if (!this.processing) {
      this.processing = true;
      setTimeout(() => this.processBatch(), this.batchTimeout);
    }

    if (this.eventQueue.length >= this.batchSize) {
      await this.processBatch();
    }
  }

  async processBatch() {
    if (this.eventQueue.length === 0) {
      this.processing = false;
      return;
    }

    const batch = this.eventQueue.splice(0, this.batchSize);

    try {
      await Promise.all(batch.map((event) => this.processEvent(event)));
    } catch (error) {
      console.error("Batch processing error:", error);
      // Handle failed events
      await this.handleFailedEvents(batch);
    }

    // Continue processing if more events exist
    if (this.eventQueue.length > 0) {
      setTimeout(() => this.processBatch(), this.batchTimeout);
    } else {
      this.processing = false;
    }
  }
}
```

### Monitoring & Alerting

```bash
# Monitor event processing health
curl -X GET "https://api.karrio.io/v1/events/health" \
  -H "Authorization: Token YOUR_API_KEY"

# Response includes health metrics
{
  "status": "healthy",
  "metrics": {
    "events_per_minute": 450,
    "processing_latency_ms": 125,
    "failed_deliveries": 2,
    "subscription_health": {
      "active_subscriptions": 15,
      "failing_subscriptions": 1
    }
  }
}
```

## What's Next?

- [Webhooks →](/docs/products/webhooks) - Webhook implementation
- [API Logs →](/docs/products/api-logs) - API logging and monitoring
- [Workflows →](/docs/products/workflows) - Automated workflows
- [API Reference →](/docs/reference/api) - Complete API documentation
