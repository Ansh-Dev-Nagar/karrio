---
sidebarTitle: Shipping Rules
title: Carrier Selection & Rate Shopping
description: Implement smart carrier selection and rate optimization using Karrio's rate shopping and carrier preference features
tags:
  [
    "carrier-selection",
    "rate-shopping",
    "optimization",
    "shipments",
    "rest-api",
  ]
---

# Carrier Selection & Rate Shopping

Implement intelligent carrier selection and rate optimization through Karrio's rate shopping API and carrier preference features. Compare rates across multiple carriers and select the best options based on your business logic.

## Overview

While Karrio doesn't include a built-in rules engine, you can implement sophisticated carrier selection logic by combining rate shopping with your application's business rules. This approach gives you complete control over carrier selection decisions.

### Key Capabilities

- **Multi-Carrier Rate Shopping**: Get rates from multiple carriers simultaneously
- **Carrier Preference**: Specify preferred carriers for rate requests
- **Service Selection**: Choose specific carrier services or let Karrio find the best rates
- **Custom Logic**: Implement your own business rules for carrier selection

## Rate Shopping & Carrier Selection

### Basic Rate Shopping

Get rates from all configured carriers:

```bash
curl -X POST "https://api.karrio.io/v1/shipments/rates" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "shipper": {
      "company_name": "Your Warehouse",
      "address_line1": "123 Warehouse St",
      "city": "Chicago",
      "state_code": "IL",
      "postal_code": "60601",
      "country_code": "US"
    },
    "recipient": {
      "person_name": "John Doe",
      "address_line1": "456 Customer Ave",
      "city": "New York",
      "state_code": "NY",
      "postal_code": "10001",
      "country_code": "US"
    },
    "parcels": [
      {
        "weight": 2.5,
        "weight_unit": "LB",
        "length": 12,
        "width": 8,
        "height": 6,
        "dimension_unit": "IN"
      }
    ]
  }'
```

### Carrier-Specific Rate Shopping

Request rates from specific carriers only:

```bash
curl -X POST "https://api.karrio.io/v1/shipments/rates" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "shipper": {
      "address_line1": "123 Warehouse St",
      "city": "Chicago",
      "state_code": "IL",
      "postal_code": "60601",
      "country_code": "US"
    },
    "recipient": {
      "person_name": "John Doe",
      "address_line1": "456 Customer Ave",
      "city": "New York",
      "state_code": "NY",
      "postal_code": "10001",
      "country_code": "US"
    },
    "parcels": [
      {
        "weight": 2.5,
        "weight_unit": "LB"
      }
    ],
    "carrier_ids": ["fedex", "ups", "usps"]
  }'
```

### Service-Specific Requests

Request specific carrier services:

```bash
curl -X POST "https://api.karrio.io/v1/shipments/rates" \
  -H "Authorization: Token YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "shipper": {
      "address_line1": "123 Warehouse St",
      "city": "Chicago",
      "state_code": "IL",
      "postal_code": "60601",
      "country_code": "US"
    },
    "recipient": {
      "person_name": "John Doe",
      "address_line1": "456 Customer Ave",
      "city": "New York",
      "state_code": "NY",
      "postal_code": "10001",
      "country_code": "US"
    },
    "parcels": [
      {
        "weight": 2.5,
        "weight_unit": "LB"
      }
    ],
    "services": ["fedex_ground", "ups_ground", "usps_priority"]
  }'
```

## Business Logic Implementation

### Cost-Based Selection

Implement cost optimization logic in your application:

```javascript
async function selectCheapestCarrier(shipmentData) {
  // Get rates from all carriers
  const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
    method: "POST",
    headers: {
      Authorization: "Token YOUR_API_KEY",
      "Content-Type": "application/json",
    },
    body: JSON.stringify(shipmentData),
  });

  const rateResponse = await response.json();

  if (!rateResponse.rates || rateResponse.rates.length === 0) {
    throw new Error("No rates available");
  }

  // Sort by total charge (ascending)
  const sortedRates = rateResponse.rates.sort(
    (a, b) => a.total_charge - b.total_charge,
  );

  return sortedRates[0]; // Return cheapest rate
}

// Usage
const shipmentData = {
  shipper: warehouseAddress,
  recipient: customerAddress,
  parcels: [{ weight: 2.5, weight_unit: "LB" }],
};

const cheapestRate = await selectCheapestCarrier(shipmentData);
console.log(
  `Selected ${cheapestRate.carrier_name} - $${cheapestRate.total_charge}`,
);
```

### Service Level Selection

Choose carriers based on service requirements:

```javascript
async function selectByServiceLevel(shipmentData, priority = "standard") {
  const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
    method: "POST",
    headers: {
      Authorization: "Token YOUR_API_KEY",
      "Content-Type": "application/json",
    },
    body: JSON.stringify(shipmentData),
  });

  const rateResponse = await response.json();

  // Filter rates based on priority
  let filteredRates = rateResponse.rates;

  if (priority === "express") {
    // Prefer express services
    filteredRates = rateResponse.rates.filter(
      (rate) =>
        rate.service.toLowerCase().includes("express") ||
        rate.service.toLowerCase().includes("overnight") ||
        rate.service.toLowerCase().includes("next_day"),
    );
  } else if (priority === "ground") {
    // Prefer ground services
    filteredRates = rateResponse.rates.filter(
      (rate) =>
        rate.service.toLowerCase().includes("ground") ||
        rate.service.toLowerCase().includes("standard"),
    );
  }

  // If no matching services, fall back to all rates
  if (filteredRates.length === 0) {
    filteredRates = rateResponse.rates;
  }

  // Sort by cost within service level
  return filteredRates.sort((a, b) => a.total_charge - b.total_charge)[0];
}

// Usage
const expressRate = await selectByServiceLevel(shipmentData, "express");
const groundRate = await selectByServiceLevel(shipmentData, "ground");
```

### Geographic-Based Selection

Route shipments based on destination:

```javascript
async function selectByDestination(shipmentData) {
  const recipient = shipmentData.recipient;

  // Define carrier preferences by region
  const carrierPreferences = {
    US: {
      domestic: ["usps", "fedex", "ups"],
      express: ["fedex", "ups", "usps"],
    },
    CA: {
      standard: ["canada_post", "fedex"],
      express: ["fedex", "ups"],
    },
    international: ["fedex", "ups", "dhl"],
  };

  let preferredCarriers;

  if (recipient.country_code === "US") {
    preferredCarriers = carrierPreferences.US.domestic;
  } else if (recipient.country_code === "CA") {
    preferredCarriers = carrierPreferences.CA.standard;
  } else {
    preferredCarriers = carrierPreferences.international;
  }

  // Request rates from preferred carriers
  const rateRequest = {
    ...shipmentData,
    carrier_ids: preferredCarriers,
  };

  const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
    method: "POST",
    headers: {
      Authorization: "Token YOUR_API_KEY",
      "Content-Type": "application/json",
    },
    body: JSON.stringify(rateRequest),
  });

  const rateResponse = await response.json();

  // Return best rate from preferred carriers
  return rateResponse.rates.sort((a, b) => a.total_charge - b.total_charge)[0];
}
```

### Weight-Based Selection

Select carriers based on package weight:

```javascript
async function selectByWeight(shipmentData) {
  const totalWeight = shipmentData.parcels.reduce(
    (sum, parcel) => sum + parcel.weight,
    0,
  );

  let preferredCarriers;

  if (totalWeight > 150) {
    // Heavy packages - prefer freight carriers
    preferredCarriers = ["freight_carrier", "ups_freight"];
  } else if (totalWeight > 50) {
    // Medium packages - prefer carriers good for heavy items
    preferredCarriers = ["ups", "fedex"];
  } else {
    // Light packages - any carrier
    preferredCarriers = ["usps", "fedex", "ups"];
  }

  const rateRequest = {
    ...shipmentData,
    carrier_ids: preferredCarriers,
  };

  const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
    method: "POST",
    headers: {
      Authorization: "Token YOUR_API_KEY",
      "Content-Type": "application/json",
    },
    body: JSON.stringify(rateRequest),
  });

  const rateResponse = await response.json();
  return rateResponse.rates.sort((a, b) => a.total_charge - b.total_charge)[0];
}
```

## Advanced Selection Logic

### Multi-Factor Selection

Combine multiple factors for intelligent carrier selection:

```javascript
class CarrierSelector {
  constructor(preferences = {}) {
    this.preferences = {
      costWeight: 0.5,
      speedWeight: 0.3,
      reliabilityWeight: 0.2,
      ...preferences,
    };

    // Carrier reliability scores (example data)
    this.reliabilityScores = {
      fedex: 0.95,
      ups: 0.92,
      usps: 0.88,
      dhl: 0.9,
    };
  }

  async selectOptimalCarrier(shipmentData, priority = "balanced") {
    // Get all available rates
    const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
      method: "POST",
      headers: {
        Authorization: "Token YOUR_API_KEY",
        "Content-Type": "application/json",
      },
      body: JSON.stringify(shipmentData),
    });

    const rateResponse = await response.json();

    if (!rateResponse.rates || rateResponse.rates.length === 0) {
      throw new Error("No rates available");
    }

    // Score each rate based on multiple factors
    const scoredRates = rateResponse.rates.map((rate) => ({
      ...rate,
      score: this.calculateScore(rate, priority),
    }));

    // Return highest scoring rate
    return scoredRates.sort((a, b) => b.score - a.score)[0];
  }

  calculateScore(rate, priority) {
    // Normalize cost (lower is better)
    const maxCost = Math.max(...rateResponse.rates.map((r) => r.total_charge));
    const costScore = 1 - rate.total_charge / maxCost;

    // Normalize speed (faster is better)
    const maxDays = Math.max(
      ...rateResponse.rates.map((r) => r.transit_days || 5),
    );
    const speedScore = 1 - (rate.transit_days || 5) / maxDays;

    // Get reliability score
    const reliabilityScore = this.reliabilityScores[rate.carrier_name] || 0.8;

    // Adjust weights based on priority
    let weights = { ...this.preferences };
    if (priority === "cost") {
      weights = { costWeight: 0.8, speedWeight: 0.1, reliabilityWeight: 0.1 };
    } else if (priority === "speed") {
      weights = { costWeight: 0.2, speedWeight: 0.6, reliabilityWeight: 0.2 };
    } else if (priority === "reliability") {
      weights = { costWeight: 0.2, speedWeight: 0.2, reliabilityWeight: 0.6 };
    }

    return (
      costScore * weights.costWeight +
      speedScore * weights.speedWeight +
      reliabilityScore * weights.reliabilityWeight
    );
  }
}

// Usage
const selector = new CarrierSelector();
const optimalRate = await selector.selectOptimalCarrier(
  shipmentData,
  "balanced",
);
console.log(
  `Selected ${optimalRate.carrier_name} with score ${optimalRate.score}`,
);
```

### Failover Logic

Implement carrier failover for reliability:

```javascript
async function createShipmentWithFailover(shipmentData, carrierPriority = []) {
  const defaultCarriers = ["fedex", "ups", "usps"];
  const carriersToTry =
    carrierPriority.length > 0 ? carrierPriority : defaultCarriers;

  for (const carrier of carriersToTry) {
    try {
      // Try to create shipment with specific carrier
      const shipment = await createShipment({
        ...shipmentData,
        carrier_ids: [carrier],
      });

      if (shipment && shipment.id) {
        console.log(`Shipment created successfully with ${carrier}`);
        return shipment;
      }
    } catch (error) {
      console.warn(`Carrier ${carrier} failed:`, error.message);
      continue;
    }
  }

  throw new Error("All carriers failed");
}

async function createShipment(shipmentData) {
  const response = await fetch("https://api.karrio.io/v1/shipments", {
    method: "POST",
    headers: {
      Authorization: "Token YOUR_API_KEY",
      "Content-Type": "application/json",
    },
    body: JSON.stringify(shipmentData),
  });

  if (!response.ok) {
    throw new Error(`Shipment creation failed: ${response.statusText}`);
  }

  return await response.json();
}

// Usage with carrier priority
const shipment = await createShipmentWithFailover(shipmentData, [
  "fedex",
  "ups",
]);
```

## Integration Patterns

### Rule-Based Selection Framework

Create a framework for implementing business rules:

```javascript
class ShippingRuleEngine {
  constructor() {
    this.rules = [];
  }

  addRule(rule) {
    this.rules.push(rule);
    // Sort by priority (higher first)
    this.rules.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  }

  async selectCarrier(shipmentData) {
    // Get all available rates
    const rates = await this.getAllRates(shipmentData);

    // Apply rules in priority order
    for (const rule of this.rules) {
      if (this.evaluateConditions(rule.conditions, shipmentData)) {
        const selectedRates = this.applyActions(rule.actions, rates);
        if (selectedRates.length > 0) {
          return selectedRates[0];
        }
      }
    }

    // Default: return cheapest rate
    return rates.sort((a, b) => a.total_charge - b.total_charge)[0];
  }

  async getAllRates(shipmentData) {
    const response = await fetch("https://api.karrio.io/v1/shipments/rates", {
      method: "POST",
      headers: {
        Authorization: "Token YOUR_API_KEY",
        "Content-Type": "application/json",
      },
      body: JSON.stringify(shipmentData),
    });

    const rateResponse = await response.json();
    return rateResponse.rates || [];
  }

  evaluateConditions(conditions, shipmentData) {
    return conditions.every((condition) => {
      const value = this.getNestedValue(shipmentData, condition.field);
      return this.compareValues(value, condition.operator, condition.value);
    });
  }

  applyActions(actions, rates) {
    let filteredRates = [...rates];

    actions.forEach((action) => {
      switch (action.type) {
        case "filter_carrier":
          filteredRates = filteredRates.filter(
            (rate) => rate.carrier_name === action.value,
          );
          break;
        case "exclude_carrier":
          filteredRates = filteredRates.filter(
            (rate) => rate.carrier_name !== action.value,
          );
          break;
        case "filter_service_type":
          filteredRates = filteredRates.filter((rate) =>
            rate.service.toLowerCase().includes(action.value.toLowerCase()),
          );
          break;
        case "sort_by_cost":
          filteredRates.sort((a, b) => a.total_charge - b.total_charge);
          break;
      }
    });

    return filteredRates;
  }

  getNestedValue(obj, path) {
    return path.split(".").reduce((current, key) => current?.[key], obj);
  }

  compareValues(actual, operator, expected) {
    switch (operator) {
      case "equals":
        return actual === expected;
      case "not_equals":
        return actual !== expected;
      case "greater_than":
        return actual > expected;
      case "less_than":
        return actual < expected;
      case "contains":
        return String(actual).includes(expected);
      default:
        return false;
    }
  }
}

// Usage
const engine = new ShippingRuleEngine();

// Add rule: Use FedEx for international shipments
engine.addRule({
  priority: 100,
  conditions: [
    { field: "recipient.country_code", operator: "not_equals", value: "US" },
  ],
  actions: [{ type: "filter_carrier", value: "fedex" }],
});

// Add rule: Use USPS for lightweight domestic packages
engine.addRule({
  priority: 50,
  conditions: [
    { field: "recipient.country_code", operator: "equals", value: "US" },
    { field: "parcels.0.weight", operator: "less_than", value: 1 },
  ],
  actions: [
    { type: "filter_carrier", value: "usps" },
    { type: "sort_by_cost" },
  ],
});

const selectedRate = await engine.selectCarrier(shipmentData);
```

## Best Practices

### Rate Shopping Optimization

```javascript
// Cache rates for similar shipments
const rateCache = new Map();

async function getCachedRates(shipmentData) {
  const cacheKey = generateCacheKey(shipmentData);

  if (rateCache.has(cacheKey)) {
    const cached = rateCache.get(cacheKey);
    // Check if cache is still valid (e.g., 15 minutes)
    if (Date.now() - cached.timestamp < 15 * 60 * 1000) {
      return cached.rates;
    }
  }

  // Get fresh rates
  const rates = await getAllRates(shipmentData);
  rateCache.set(cacheKey, {
    rates,
    timestamp: Date.now(),
  });

  return rates;
}

function generateCacheKey(shipmentData) {
  const { shipper, recipient, parcels } = shipmentData;
  return `${shipper.postal_code}-${recipient.postal_code}-${JSON.stringify(parcels)}`;
}
```

### Error Handling

```javascript
async function robustCarrierSelection(shipmentData) {
  try {
    // First try: get rates from all carriers
    const rates = await getAllRates(shipmentData);

    if (rates.length === 0) {
      throw new Error("No carriers available");
    }

    return selectBestRate(rates);
  } catch (error) {
    console.warn("Primary carrier selection failed:", error);

    // Fallback: try with specific reliable carriers
    try {
      const fallbackRates = await getAllRates({
        ...shipmentData,
        carrier_ids: ["fedex", "ups"], // Known reliable carriers
      });

      if (fallbackRates.length > 0) {
        return fallbackRates[0];
      }
    } catch (fallbackError) {
      console.error("Fallback carrier selection failed:", fallbackError);
    }

    throw new Error("All carrier selection methods failed");
  }
}
```

## What's Next?

- [Shipments →](/docs/products/shipments) - Create shipments with selected carriers
- [Batch Processing →](/docs/products/batch-processing) - Optimize bulk shipment processing
- [Webhooks →](/docs/products/webhooks) - Monitor shipment events
- [API Reference →](/docs/reference/rest) - Complete REST API documentation
